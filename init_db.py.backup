#!/usr/bin/env python
"""Script untuk inisialisasi database MySQL"""
import sys
import os

# Tambahkan current directory ke Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core.models import init_db
import logging
from core.database import DatabaseManager
from config.settings import DATABASE_URL

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def check_mysql_connection():
    """Test koneksi MySQL"""
    try:
        import pymysql
        from config.settings import DB_HOST, DB_USER, DB_PASSWORD, DB_NAME, DB_PORT
        
        connection = pymysql.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
            port=DB_PORT
        )
        logger.info("‚úÖ MySQL connection successful!")
        connection.close()
        return True
    except Exception as e:
        logger.error(f"‚ùå MySQL connection failed: {e}")
        logger.error("Please check your MySQL credentials in .env file")
        return False

if __name__ == "__main__":
    print("=" * 50)
    print("SOC Telegram Bot - Database Initialization")
    print("=" * 50)
    
    # Cek koneksi MySQL dulu
    if not check_mysql_connection():
        print("\n‚ùå Failed to connect to MySQL. Please check:")
        print("1. MySQL is running: sudo systemctl status mysql")
        print("2. Credentials in .env file")
        print("3. Database 'soc_telegram' exists")
        exit(1)
    
    print("\nüì¶ Creating database tables...")
    try:
        init_db()
        print("‚úÖ Database tables created successfully!")
        
        # Test dengan DatabaseManager
        print("\nüîç Testing DatabaseManager...")
        db = DatabaseManager()
        test_alert = db.save_alert({
            'timestamp': '2026-02-18 00:00:00',
            'alert_type': 'test',
            'message': 'Test alert',
            'severity': 'low',
            'attack_count': 1
        })
        print(f"‚úÖ Test alert saved with ID: {test_alert.id}")
        db.close()
        
        print("\nüéâ Database initialization complete!")
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
